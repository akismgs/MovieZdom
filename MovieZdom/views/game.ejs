<!DOCTYPE html>
<html lang="el">
  <head>
    <meta charset="UTF-8">
    <title>MovieZdom - Το Παιχνίδι Ξεκίνησε!</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { background-color: #1a1a2e; color: white; overflow: hidden; }
      .timer-container { height: 8px; width: 100%; background: #16213e; position: fixed; top: 0; left: 0; }
      .timer-bar { height: 100%; width: 100%; background: #e94560; transition: width 0.1s linear; }
      .option-btn { 
        background: #0f3460; border: 2px solid #16213e; color: white; 
        padding: 20px; border-radius: 10px; cursor: pointer; transition: 0.3s;
      }
      .option-btn:hover { background: #16213e; }
      .option-selected { background: #fca311 !important; border-color: #ffb703; }
      .option-correct { background: #2a9d8f !important; border-color: #e9c46a; }
      .option-wrong { background: #e63946 !important; }
      
      #countdown-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.9); display: flex; justify-content: center;
        align-items: center; z-index: 2000; font-size: 10rem; font-weight: bold;
      }
    </style>
  </head>
  
  <body>

    <div id="countdown-overlay">3</div>

    <div class="timer-container">
      <div id="timerBar" class="timer-bar"></div>
    </div>

    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-8 text-center">
          <div class="d-flex justify-content-between mb-4">
            <span>Ερώτηση: <span id="qIndex">1</span>/10</span>
            <span>Score: <span id="myScore">0</span></span>
          </div>
          <h2 id="questionText" class="mb-5">Φόρτωση ερώτησης...</h2>
          <div id="optionsGrid" class="row g-3"></div>
          <p id="statusMsg" class="mt-4 text-info"></p>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const lobbyId = "<%= lobbyId %>";
      let myScore = 0;

      // Σύνδεση στο δωμάτιο
      socket.emit('joinGame', lobbyId);

      // 1. Αντίστροφη μέτρηση πριν την έναρξη
      socket.on('startCountdown', () => {
        let count = 3;
        const overlay = document.getElementById('countdown-overlay');
        const interval = setInterval(() => {
          count--;
          if(count === 0) {
            overlay.innerText = "Πάμε!";
          } else if(count < 0) {
            clearInterval(interval);
            overlay.style.display = 'none';
          } else {
            overlay.innerText = count;
          }
        }, 1000);
      });

      // 2. Εμφάνιση Ερώτησης
      socket.on('newQuestion', (data) => {
        document.getElementById('qIndex').innerText = data.index + 1;
        document.getElementById('questionText').innerText = data.question;
        const grid = document.getElementById('optionsGrid');
        grid.innerHTML = '';
        document.getElementById('statusMsg').innerText = "";
        
        // Επαναφορά μπάρας χρόνου
        const bar = document.getElementById('timerBar');
        bar.style.transition = 'none';
        bar.style.width = '100%';
        setTimeout(() => {
          bar.style.transition = 'width 10s linear';
          bar.style.width = '0%';
        }, 50);

        data.options.forEach(opt => {
          const btn = document.createElement('div');
          btn.className = 'col-6';
          btn.innerHTML = `<div class="option-btn" onclick="selectOption(this, '${opt}')">${opt}</div>`;
          grid.appendChild(btn);
        });
      });

      function selectOption(el, val) {
        // Απενεργοποίηση άλλων επιλογών
        const btns = document.querySelectorAll('.option-btn');
        btns.forEach(b => b.style.pointerEvents = 'none');
        el.classList.add('option-selected');
        
        socket.emit('submitAnswer', { lobbyId, answer: val });
        document.getElementById('statusMsg').innerText = "Περιμένοντας τον αντίπαλο...";
      }

      // 3. Αποτέλεσμα Ερώτησης
      socket.on('revealResult', (data) => {
        const btns = document.querySelectorAll('.option-btn');
        btns.forEach(btn => {
          if(btn.innerText === data.correctAnswer) {
            btn.classList.add('option-correct');
            btn.classList.remove('option-selected');
          } else if(btn.classList.contains('option-selected')) {
            btn.classList.add('option-wrong');
          }
        });

        if(data.isCorrect) {
          myScore += 3;
          document.getElementById('myScore').innerText = myScore;
        }
      });
    </script>
  </body>
</html>